# 总入口

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# 门户 http 只支持域名跳转
server{
    listen 80;
    server_name pre4.cicbus.cn;
    rewrite ^/(.*)$ https://pre4.cicbus.cn/$1 permanent;
}

# 门户 https
server
{
    listen 443 ssl;
    listen 6443 ssl;
    server_name pre4.cicbus.cn 192.168.0.202 localhost;

    # 处理请求413错误
    client_max_body_size 100M;  # 设置请求体缓存区大小
    client_body_buffer_size 128k; # 设置客户端请求体最大值

    # 添加安全头信息
    add_header Cache-Control no-cache;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection 1;
    add_header Strict-Transport-Security: "max-age=63072000; includeSubDomains";
    add_header X-Frame-Options SAMEORIGIN;
    #add_header Content-Security-Policy "script-src 'self' 'unsafe-inline'";
    add_header Access-Control-Allow-Origin $host;
    server_tokens off;

    # 调度系统前端
    location /dispatch/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6001/;
    }

    # 大数据分析平台前端（包含客流、线网、驾驶行为）
    location /bdap/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6002/;
    }

     # 客流服务前端 4.1
    location /bdap-pfanalysis/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60021/;
    }

    # 线网服务前端 4.1
    location /bdap-network/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60021/;
    }

    # 驾驶行为服务前端
    location /bdap-jsxw/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60023/;
    }

    # ERP
    location /erp/ {
        # proxy_redirect off;
        # 解决tomcat302头为http的问题
        proxy_redirect http:// $scheme://;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.0.202:6003/erp/;
    }

    # 信息发布前端
    location /irp/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6004/;
    }

    # 基础数据前端
    location /aiot-data-platform/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60051/;
    }

    # 统一门户前端
    location / {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60052/;
    }

    # 公共管理前端
    location /aiot-ups-common-management/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60053/;
    }

    # 数据总线前端
    location /aiot-dss/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60054/;
    }

    # 车联网前端
    location /aiot-tplatform-devops/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6005/;
    }

    # 场站服务前端
    location /smp/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6006/;
    }

    # 场站h5app服务前端
    location /smp-h5/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:60061/;
    }

    # 组合测试前端
    location /test/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:6010/;
    }

    # 网关
    location /gateway/ {
        set $scheme_flag 0;
        set $referer_flag 0;

        if ($scheme = "https") {
            set $scheme_flag 1;
        }

        # 验证referer
        valid_referers pre4.cicbus.cn 192.168.0.202 localhost;
        if ($invalid_referer) {
            set $scheme_flag 1;
        }

        # https中才验证referer属性
        set $flag "${scheme_flag}${referer_flag}";
        if ($flag = 11) {
            return 403;
        }

        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:8001/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;

        access_log /data/cicsoft/nginx/logs/cictec-gateway-access.log;
        error_log /data/cicsoft/nginx/logs/cictec-gateway-error.log;
    }

    # 通过ws连接rabbitmq，路径后不能加/
    location /ws {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际rabbitmq服务地址
        proxy_pass http://192.168.0.202:15674;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
    }

    # minio todo 还需验证可用性
    location /minio/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际minio服务地址
        proxy_pass http://localhost:9000/;
    }

    # ftp
    location /ftp/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际ftp服务地址
        proxy_pass http://192.168.0.202:6100/;
    }

    # rabbitmq
    location /rabbitmq-admin/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际rabbitmq服务地址
        proxy_pass http://192.168.0.202:15672/;
    }

    # rabbitmq增强，处理交换机、队列详情Not found的问题
    location ~* /rabbitmq-admin/api/ {
        rewrite ^ $request_uri;
        rewrite ^/rabbitmq-admin/api/(.*) /api/$1 break;
        return 400;
        proxy_buffering off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # 服务器上改为实际rabbitmq服务地址
        proxy_pass http://192.168.0.202:15672$uri;
    }

    # es
    location /es-admin/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际es服务地址
        proxy_pass http://192.168.0.202:9100/;
    }

    # xxl-job，路径后不能加/
    location /xxl-job-admin {
        # proxy_redirect off;
        proxy_redirect http:// $scheme://;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际xxl-job服务地址
        proxy_pass http://192.168.0.202:8868;
    }

    # sentinel
    location /sentinel-admin/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际sentinel服务地址
        proxy_pass http://192.168.0.202:7000/;
    }

    # skywalking
    location /skywalking-admin/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 服务器上改为实际skywalking服务地址
        proxy_pass http://192.168.0.202:9411/;
    }

    # mapwith
    location /mapwith/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass https://mapwith.ai/;
    }

    # mapwith
    location /openstreetmap/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass https://openstreetmap.org/;
    }

    # 瑞明实时视频
    location /video/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.0.98:12060/;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
    }

    # 中航讯实时视频
    location /zhx-video/ {
        proxy_redirect off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.10.185:31081/;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
    }

    ssl_certificate /data/cicsoft/nginx/config/ssl_cer/cicbus.cn.pem;
    ssl_certificate_key /data/cicsoft/nginx/config/ssl_cer/cicbus.cn.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;

    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4;
    ssl_prefer_server_ciphers on;

    access_log /data/cicsoft/nginx/logs/cictec-portal-access.log;
    error_log /data/cicsoft/nginx/logs/cictec-portal-error.log;
}
